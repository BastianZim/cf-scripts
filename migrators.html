
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Making Migrators &#8212; cf-scripts  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to cf-scripts’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="making-migrators">
<h1>Making Migrators<a class="headerlink" href="#making-migrators" title="Permalink to this headline">¶</a></h1>
<p>Migration is an important part of the regro-cf-autotick-bot’s duties.
Migrations usually change how many feedstocks/packages operate, these can be
as simple as a yaml syntax change, or as complex as moving compiler stacks.
Most migrations are due to a change in the global pinning, as packages change
their pinning, the entire stack which depends directly on that package will
need to be updated.
This document will teach you how to create new migrators</p>
</div>
<div class="section" id="building-a-migration">
<h1>Building a Migration<a class="headerlink" href="#building-a-migration" title="Permalink to this headline">¶</a></h1>
<p>To build a <code class="docutils literal notranslate"><span class="pre">Rebuild</span></code> Migrator it must be added to <code class="docutils literal notranslate"><span class="pre">auto_tick.xsh</span></code>.</p>
<div class="section" id="adding-to-auto-tick-xsh">
<h2>Adding to <code class="docutils literal notranslate"><span class="pre">auto_tick.xsh</span></code><a class="headerlink" href="#adding-to-auto-tick-xsh" title="Permalink to this headline">¶</a></h2>
<p>To have the bot run the migration we need to add the migrator to add it to the
<code class="docutils literal notranslate"><span class="pre">auto_tick</span></code> module.
If the migrator needs no information about the graph (eg. version bumps) then
it can be added to the <code class="docutils literal notranslate"><span class="pre">$MIGRATORS</span></code> list directly.
If the migrator needs graph information (eg it runs in topo order) then it
needs to be added by a function (eg. <code class="docutils literal notranslate"><span class="pre">add_rebuild</span></code>).
This function takes in the list of migrators and the entire package graph.
The job of the function is to pair down the graph to the nodes which need
to be migrated, for instance only packages which require <code class="docutils literal notranslate"><span class="pre">python</span></code>.
This paired down graph is passed into the migrator, which is then added
to the migrators list.
Many times one can use the <code class="docutils literal notranslate"><span class="pre">Rebuild</span></code> class without having to create
a custom migrator.
Custom migrators are used when the internals of the conda-forge system (the various
yaml configuration files) need to be changed.</p>
<p>Example of migrator addition function for openssl, for most simple re-pinning migration
one could replace <code class="docutils literal notranslate"><span class="pre">openssl</span></code> with the package which got pinned and things would work:</p>
<blockquote>
<div><div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_rebuild_openssl</span><span class="p">(</span><span class="n">migrators</span><span class="p">,</span> <span class="n">gx</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;Adds rebuild openssl migrators.</span>

<span class="sd">Parameters</span>
<span class="sd">----------</span>
<span class="sd">migrators : list of Migrator</span>
<span class="sd">    The list of migrators to run.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">total_graph</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gx</span><span class="p">)</span>

<span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">gx</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">meta_yaml</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta_yaml&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">bh</span> <span class="o">=</span> <span class="n">get_requirements</span><span class="p">(</span><span class="n">meta_yaml</span><span class="p">)</span>
    <span class="n">openssl_c</span> <span class="o">=</span> <span class="s1">&#39;openssl&#39;</span> <span class="ow">in</span> <span class="n">bh</span>

    <span class="n">rq</span> <span class="o">=</span> <span class="n">_host_run_test_dependencies</span><span class="p">(</span><span class="n">meta_yaml</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">total_graph</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span><span class="n">node</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rq</span><span class="p">:</span>
            <span class="n">total_graph</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">openssl_c</span><span class="p">]):</span>
        <span class="n">pluck</span><span class="p">(</span><span class="n">total_graph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

<span class="c1"># post plucking we can have several strange cases, lets remove all selfloops</span>
<span class="n">total_graph</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">total_graph</span><span class="o">.</span><span class="n">selfloop_edges</span><span class="p">())</span>

<span class="c1"># everything which depends on openssl and has not predecessors in the</span>
<span class="c1"># openssl dependents graph</span>
<span class="n">top_level</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">gx</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="s2">&quot;openssl&quot;</span><span class="p">)</span> <span class="k">if</span>
             <span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="n">total_graph</span><span class="p">)</span> <span class="ow">and</span>
             <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">total_graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">}</span>
<span class="c1"># Since we can&#39;t figure out what order to build packages in a cycle in</span>
<span class="c1"># we build them all at once</span>
<span class="n">cycles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">simple_cycles</span><span class="p">(</span><span class="n">total_graph</span><span class="p">))</span>

<span class="n">migrators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">Rebuild</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">total_graph</span><span class="p">,</span>
            <span class="n">pr_limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;OpenSSL&#39;</span><span class="p">,</span>
            <span class="n">top_level</span><span class="o">=</span><span class="n">top_level</span><span class="p">,</span>
            <span class="n">cycles</span><span class="o">=</span><span class="n">cycles</span><span class="p">,</span> <span class="n">obj_version</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">cf-scripts</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Making Migrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="#building-a-migration">Building a Migration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-to-auto-tick-xsh">Adding to <code class="docutils literal notranslate"><span class="pre">auto_tick.xsh</span></code></a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to cf-scripts’s documentation!</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Conda-forge-tick Development Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/migrators.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>